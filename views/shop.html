<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shop - Premium Luxury Watches | WatchBuy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="/css/style.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <meta name="description" content="Browse our premium collection of luxury watches at WatchBuy. Find your perfect timepiece.">
</head>
<body>

<!-- Enhanced Navbar -->
<nav class="navbar navbar-expand-lg shadow-sm" id="mainNavbar">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/">
      <i class="bi bi-clock-history me-2"></i>Watch<span class="text-gold">Buy</span>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-between" id="mainNav">
      <ul class="navbar-nav mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-house me-1"></i>Home</a></li>
        <li class="nav-item"><a class="nav-link active" href="/shop"><i class="bi bi-shop me-1"></i>Shop</a></li>
        <li class="nav-item"><a class="nav-link" href="/search"><i class="bi bi-search me-1"></i>Search</a></li>
        <li class="nav-item"><a class="nav-link" href="#contact"><i class="bi bi-envelope me-1"></i>Contact</a></li>
      </ul>

      <form class="d-flex mx-auto" role="search" action="/search" method="GET" style="width: 350px;">
        <div class="search-container w-100">
          <input class="form-control" type="search" name="q" id="mainSearchInput" placeholder="Search luxury watches..." aria-label="Search" autocomplete="off">
          <button class="btn" type="submit">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </form>

      <div class="d-flex align-items-center" id="auth-buttons">
        <a href="/login" class="btn btn-outline-primary me-2">
          <i class="bi bi-box-arrow-in-right me-1"></i>Login
        </a>
        <a href="/register" class="btn btn-primary">
          <i class="bi bi-person-plus me-1"></i>Register
        </a>
      </div>
    </div>
  </div>
</nav>

<!-- Enhanced Shop Header -->
<section class="shop-header py-5">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h1 class="display-4 fw-bold mb-3">
          <span class="text-gold">Premium</span> Watch Collection
        </h1>
        <p class="lead text-muted mb-4">
          Discover our curated selection of luxury timepieces. Each watch is carefully selected for quality, style, and craftsmanship.
        </p>
        <div class="shop-stats">
          <div class="stat-item">
            <i class="bi bi-gem text-gold"></i>
            <span>Premium Quality</span>
          </div>
          <div class="stat-item">
            <i class="bi bi-shield-check text-success"></i>
            <span>Authentic</span>
          </div>
          <div class="stat-item">
            <i class="bi bi-truck text-info"></i>
            <span>Fast Delivery</span>
          </div>
        </div>
      </div>
      <div class="col-lg-4 text-center">
        <div class="shop-illustration">
          <i class="bi bi-clock-history display-1 text-gold"></i>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Enhanced Shop Content -->
<section class="shop-content py-5">
  <div class="container">
    <!-- Filters and Search -->
    <div class="shop-controls mb-5">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="filters">
            <button class="btn btn-outline-primary me-2" id="filterAll">
              <i class="bi bi-grid me-1"></i>All
            </button>
            <button class="btn btn-outline-secondary me-2" id="filterLuxury">
              <i class="bi bi-gem me-1"></i>Luxury
            </button>
            <button class="btn btn-outline-secondary me-2" id="filterSport">
              <i class="bi bi-speedometer2 me-1"></i>Sport
            </button>
            <button class="btn btn-outline-secondary me-2" id="filterBusiness">
              <i class="bi bi-briefcase me-1"></i>Business
            </button>
          </div>
        </div>
        <div class="col-md-6">
          <div class="shop-actions">
            <div class="d-flex align-items-center justify-content-md-end">
              <label class="me-2 text-muted">Sort by:</label>
              <select class="form-select form-select-sm" style="width: auto;" id="sortSelect">
                <option value="name">Name</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
                <option value="newest">Newest</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Products Grid -->
    <div class="row g-4" id="productList">
      <!-- Loading skeleton -->
      <div class="col-12 text-center">
        <div class="loading-spinner mb-3"></div>
        <p class="text-muted">Loading premium watches...</p>
      </div>
    </div>

    <!-- Load More Button -->
    <div class="text-center mt-5" id="loadMoreSection" style="display: none;">
      <button class="btn btn-outline-primary btn-lg" id="loadMoreBtn">
        <i class="bi bi-arrow-down me-2"></i>Load More Watches
      </button>
    </div>
  </div>
</section>

<!-- Enhanced Footer -->
<footer id="contact" class="footer-enhanced">
  <div class="container">
    <div class="row g-4">
      <div class="col-lg-4">
        <h5 class="mb-3">
          <i class="bi bi-clock-history me-2"></i>WatchBuy
        </h5>
        <p class="text-muted mb-3">
          Your premier destination for luxury timepieces. We bring you the finest watches from around the world.
        </p>
        <div class="social-links">
          <a href="#" class="social-link"><i class="bi bi-facebook"></i></a>
          <a href="#" class="social-link"><i class="bi bi-instagram"></i></a>
          <a href="#" class="social-link"><i class="bi bi-twitter"></i></a>
          <a href="#" class="social-link"><i class="bi bi-linkedin"></i></a>
        </div>
      </div>
      <div class="col-lg-2 col-md-6">
        <h6 class="mb-3">Quick Links</h6>
        <ul class="footer-links">
          <li><a href="/shop">Shop</a></li>
          <li><a href="/search">Search</a></li>
          <li><a href="/about">About Us</a></li>
          <li><a href="/contact">Contact</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-md-6">
        <h6 class="mb-3">Support</h6>
        <ul class="footer-links">
          <li><a href="/help">Help Center</a></li>
          <li><a href="/shipping">Shipping Info</a></li>
          <li><a href="/returns">Returns</a></li>
          <li><a href="/warranty">Warranty</a></li>
        </ul>
      </div>
      <div class="col-lg-4">
        <h6 class="mb-3">Contact Info</h6>
        <div class="contact-info">
          <p><i class="bi bi-geo-alt me-2"></i>123 Luxury Ave, Metro Manila, Philippines</p>
          <p><i class="bi bi-telephone me-2"></i>+63 912 345 6789</p>
          <p><i class="bi bi-envelope me-2"></i>support@watchbuy.com</p>
        </div>
      </div>
    </div>
    
    <div class="footer-bottom">
      <div class="row align-items-center">
        <div class="col-md-6">
          <p class="mb-0">&copy; 2025 WatchBuy Co. All rights reserved.</p>
        </div>
        <div class="col-md-6 text-md-end">
          <div class="payment-methods">
            <i class="bi bi-credit-card me-2"></i>
            <i class="bi bi-paypal me-2"></i>
            <i class="bi bi-wallet2 me-2"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>

<!-- Back to Top Button -->
<button id="backToTop" class="back-to-top">
  <i class="bi bi-arrow-up"></i>
</button>

<script src="/js/notifications.js"></script>
<script>
  // Enhanced navbar scroll effect
  window.addEventListener('scroll', function() {
    const navbar = document.getElementById('mainNavbar');
    if (window.scrollY > 50) {
      navbar.classList.add('scrolled');
    } else {
      navbar.classList.remove('scrolled');
    }
  });

  // Back to top functionality
  const backToTopBtn = document.getElementById('backToTop');
  window.addEventListener('scroll', function() {
    if (window.scrollY > 300) {
      backToTopBtn.style.display = 'block';
    } else {
      backToTopBtn.style.display = 'none';
    }
  });

  backToTopBtn.addEventListener('click', function() {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  });

  // Session management
  fetch('/session-data')
    .then(res => res.json())
    .then(data => {
      const nav = document.querySelector('.navbar-nav');
      const authArea = document.getElementById('auth-buttons');

      if (data.loggedIn) {
        if (data.user.role === 'admin') {
          nav.innerHTML = `
            <li class="nav-item"><a class="nav-link" href="/admin/dashboard"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="/admin/products"><i class="bi bi-box me-1"></i>Products</a></li>
            <li class="nav-item"><a class="nav-link" href="/admin/orders"><i class="bi bi-cart me-1"></i>Orders</a></li>
          `;
        } else {
          nav.innerHTML = `
            <li class="nav-item"><a class="nav-link" href="/shop"><i class="bi bi-shop me-1"></i>Shop</a></li>
            <li class="nav-item"><a class="nav-link" href="/orders"><i class="bi bi-bag me-1"></i>My Orders</a></li>
            <li class="nav-item"><a class="nav-link" href="/profile"><i class="bi bi-person me-1"></i>Profile</a></li>
          `;
        }

        let cartButton = '';
        if (data.user.role !== 'admin') {
          cartButton = `<a href="/cart" class="btn btn-outline-primary me-2"><i class="bi bi-cart me-1"></i>Cart</a>`;
        }

        authArea.innerHTML = `
          <span class="text-light me-3"><i class="bi bi-person-circle me-1"></i>Welcome, ${data.user.fname}</span>
          ${cartButton}
          <a href="/logout" class="btn btn-danger"><i class="bi bi-box-arrow-right me-1"></i>Logout</a>
        `;
      }
    });

  const priceMap = {
    1: 1499,
    2: 2299,
    3: 1299,
    4: 999,
    // Add more as needed
  };

  let allProducts = [];
  let filteredProducts = [];
  let currentPage = 1;
  const productsPerPage = 9;

  async function loadProducts() {
    try {
      const data = await fetchWithNotification('/api/products', {
        method: 'GET'
      }, {
        showLoading: false,
        showSuccess: false,
        showError: true
      });
      
      if (data) {
        allProducts = data;
        filteredProducts = data;
        
        // Check if user is admin
        let isAdmin = false;
        try {
          const sessionResponse = await fetch('/session-data');
          const sessionData = await sessionResponse.json();
          isAdmin = sessionData.loggedIn && sessionData.user.role === 'admin';
        } catch (error) {
          console.log('Could not check user session:', error);
        }
        
        displayProducts(isAdmin);
        setupFilters();
        setupSorting();
      }
    } catch (error) {
      console.error('Load products error:', error);
      showErrorState();
    }
  }

  function displayProducts(isAdmin = false, products = filteredProducts) {
    const list = document.getElementById('productList');
    const startIndex = (currentPage - 1) * productsPerPage;
    const endIndex = startIndex + productsPerPage;
    const productsToShow = products.slice(startIndex, endIndex);

    if (currentPage === 1) {
      list.innerHTML = '';
    }

    if (productsToShow.length === 0) {
      if (currentPage === 1) {
        list.innerHTML = `
          <div class="col-12 text-center">
            <div class="empty-state">
              <i class="bi bi-search display-1 text-muted mb-3"></i>
              <h4>No Products Found</h4>
              <p class="text-muted">Try adjusting your filters or search criteria.</p>
              <button class="btn btn-primary" onclick="resetFilters()">
                <i class="bi bi-arrow-clockwise me-2"></i>Reset Filters
              </button>
            </div>
          </div>
        `;
      }
      return;
    }

    productsToShow.forEach(product => {
      const col = document.createElement('div');
      col.className = 'col-lg-4 col-md-6 mb-4';

      const price = priceMap[product.id]
        ? `₱${priceMap[product.id].toLocaleString()}`
        : '₱N/A';

      // Hide cart functionality for admin users
      const cartSection = isAdmin ? `
        <div class="alert alert-info alert-sm">
          <small><i class="bi bi-info-circle me-1"></i> Admin users cannot add items to cart</small>
        </div>
      ` : `
        <div class="product-actions">
          <div class="quantity-controls mb-3">
            <label for="qty-${product.id}" class="form-label">Quantity</label>
            <div class="input-group">
              <button class="btn btn-outline-secondary btn-sm" onclick="changeQuantity(${product.id}, -1)">-</button>
              <input type="number" min="1" max="${product.quantity}" value="1" id="qty-${product.id}" class="form-control form-control-sm text-center" />
              <button class="btn btn-outline-secondary btn-sm" onclick="changeQuantity(${product.id}, 1)">+</button>
            </div>
          </div>
        </div>
      `;

      col.innerHTML = `
        <div class="card product-card h-100">
          <div class="card-image-container">
            ${product.images && Array.isArray(product.images) && product.images.length > 0 ? `
              <div id="carousel-${product.id}" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                  ${product.images.map((img, idx) => `
                    <div class="carousel-item ${idx === 0 ? 'active' : ''}">
                      <img src="${img}" class="card-img-top" alt="${product.name}" onerror="this.src='https://via.placeholder.com/400x250?text=Product+Image'">
                    </div>
                  `).join('')}
                </div>
                ${product.images.length > 1 ? `
                  <button class="carousel-control-prev" type="button" data-bs-target="#carousel-${product.id}" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  </button>
                  <button class="carousel-control-next" type="button" data-bs-target="#carousel-${product.id}" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  </button>
                ` : ''}
              </div>
            ` : `
              <img src="${product.img_path || 'https://via.placeholder.com/400x250?text=Product+Image'}" class="card-img-top" alt="${product.name}" onerror="this.src='https://via.placeholder.com/400x250?text=Product+Image'">
            `}
            <div class="card-overlay">
              <div class="overlay-buttons">
                <a href="/product.html?id=${product.id}" class="btn btn-primary btn-sm">
                  <i class="bi bi-eye"></i>
                </a>
              </div>
            </div>
            <div class="card-badge">
              <span class="badge bg-primary">${product.category_name || 'Premium'}</span>
            </div>
          </div>
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">${product.name}</h5>
            <p class="card-text flex-grow-1">${product.description || 'Premium timepiece with exceptional craftsmanship.'}</p>
            <div class="product-details mb-3">
              <div class="price-section">
                <span class="card-price">${price}</span>
                <span class="stock-info">
                  <i class="bi bi-check-circle-fill text-success me-1"></i>
                  ${product.quantity} in stock
                </span>
              </div>
            </div>
            ${cartSection}
            <div class="mt-3">
              <a href="/product.html?id=${product.id}" class="btn btn-outline-primary w-100">
                <i class="bi bi-eye me-2"></i>View Details
              </a>
            </div>
          </div>
        </div>
      `;

      list.appendChild(col);
    });

    // Show/hide load more button
    const loadMoreSection = document.getElementById('loadMoreSection');
    if (endIndex < products.length) {
      loadMoreSection.style.display = 'block';
    } else {
      loadMoreSection.style.display = 'none';
    }

    // Attach event listeners to "Add to Cart" buttons (only if not admin)
    if (!isAdmin) {
      // Quick add buttons
      document.querySelectorAll('.quick-add-btn').forEach(button => {
        button.addEventListener('click', async () => {
          const productId = button.getAttribute('data-product-id');
          try {
            const result = await cartOperations.addToCart(productId, 1);
            if (result && result.success) {
              // Success notification is handled by cartOperations
            }
          } catch (error) {
            console.error('Quick add to cart error:', error);
          }
        });
      });
    }
  }

  function setupFilters() {
    const filterButtons = document.querySelectorAll('#filterAll, #filterLuxury, #filterSport, #filterBusiness');
    
    filterButtons.forEach(button => {
      button.addEventListener('click', function() {
        // Remove active class from all buttons
        filterButtons.forEach(btn => {
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-outline-secondary');
        });
        
        // Add active class to clicked button
        this.classList.remove('btn-outline-secondary');
        this.classList.add('btn-primary');
        
        // Filter products
        const filterType = this.id.replace('filter', '').toLowerCase();
        filterProducts(filterType);
      });
    });
  }

  function filterProducts(filterType) {
    currentPage = 1;
    
    if (filterType === 'all') {
      filteredProducts = allProducts;
    } else {
      filteredProducts = allProducts.filter(product => 
        product.category_name && product.category_name.toLowerCase().includes(filterType)
      );
    }
    
    // Re-apply sorting
    const sortSelect = document.getElementById('sortSelect');
    sortProducts(sortSelect.value);
    
    // Check if user is admin
    let isAdmin = false;
    fetch('/session-data')
      .then(res => res.json())
      .then(data => {
        isAdmin = data.loggedIn && data.user.role === 'admin';
        displayProducts(isAdmin, filteredProducts);
      });
  }

  function setupSorting() {
    const sortSelect = document.getElementById('sortSelect');
    sortSelect.addEventListener('change', function() {
      sortProducts(this.value);
      
      // Check if user is admin
      let isAdmin = false;
      fetch('/session-data')
        .then(res => res.json())
        .then(data => {
          isAdmin = data.loggedIn && data.user.role === 'admin';
          displayProducts(isAdmin, filteredProducts);
        });
    });
  }

  function sortProducts(sortType) {
    switch(sortType) {
      case 'name':
        filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
        break;
      case 'price-low':
        filteredProducts.sort((a, b) => (priceMap[a.id] || 0) - (priceMap[b.id] || 0));
        break;
      case 'price-high':
        filteredProducts.sort((a, b) => (priceMap[b.id] || 0) - (priceMap[a.id] || 0));
        break;
      case 'newest':
        filteredProducts.sort((a, b) => b.id - a.id);
        break;
    }
  }

  function resetFilters() {
    currentPage = 1;
    filteredProducts = allProducts;
    
    // Reset filter buttons
    const filterButtons = document.querySelectorAll('#filterAll, #filterLuxury, #filterSport, #filterBusiness');
    filterButtons.forEach(btn => {
      btn.classList.remove('btn-primary');
      btn.classList.add('btn-outline-secondary');
    });
    document.getElementById('filterAll').classList.remove('btn-outline-secondary');
    document.getElementById('filterAll').classList.add('btn-primary');
    
    // Reset sort
    document.getElementById('sortSelect').value = 'name';
    
    // Check if user is admin
    let isAdmin = false;
    fetch('/session-data')
      .then(res => res.json())
      .then(data => {
        isAdmin = data.loggedIn && data.user.role === 'admin';
        displayProducts(isAdmin, filteredProducts);
      });
  }

  function changeQuantity(productId, change) {
    const input = document.getElementById(`qty-${productId}`);
    const currentValue = parseInt(input.value) || 1;
    const newValue = Math.max(1, currentValue + change);
    input.value = newValue;
  }

  function showErrorState() {
    document.getElementById('productList').innerHTML = `
      <div class="col-12 text-center">
        <div class="error-state">
          <i class="bi bi-exclamation-triangle display-1 text-warning mb-3"></i>
          <h4>Error Loading Products</h4>
          <p class="text-muted">Please try again later.</p>
          <button class="btn btn-primary" onclick="loadProducts()">
            <i class="bi bi-arrow-clockwise me-2"></i>Retry
          </button>
        </div>
      </div>
    `;
  }

  // Load more functionality
  document.getElementById('loadMoreBtn').addEventListener('click', function() {
    currentPage++;
    let isAdmin = false;
    fetch('/session-data')
      .then(res => res.json())
      .then(data => {
        isAdmin = data.loggedIn && data.user.role === 'admin';
        displayProducts(isAdmin, filteredProducts);
      });
  });

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
    notify.info('Welcome to Shop', 'Browse our collection of premium watches');
  });
</script>

<style>
/* Additional styles for shop page */
.shop-header {
  background: linear-gradient(135deg, var(--background-secondary), var(--background-tertiary));
  position: relative;
  overflow: hidden;
}

.shop-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23f59e0b" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
  opacity: 0.3;
}

.shop-stats {
  display: flex;
  gap: 2rem;
  flex-wrap: wrap;
}

.stat-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 500;
  color: var(--text-secondary);
}

.stat-item i {
  font-size: 1.25rem;
}

.shop-illustration {
  animation: float 6s ease-in-out infinite;
}

.shop-controls {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(20px);
  border-radius: var(--border-radius-xl);
  padding: 2rem;
  box-shadow: var(--shadow-lg);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.filters .btn {
  border-radius: var(--border-radius-full);
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
}

.product-actions {
  background: var(--background-secondary);
  border-radius: var(--border-radius);
  padding: 1rem;
  margin-top: 1rem;
}

.quantity-controls .input-group {
  max-width: 150px;
}

.quantity-controls .btn {
  border-radius: var(--border-radius-sm);
}

.product-details {
  border-top: 1px solid var(--border-light);
  padding-top: 1rem;
}

.empty-state,
.error-state {
  padding: 3rem;
}

@media (max-width: 768px) {
  .shop-stats {
    gap: 1rem;
  }
  
  .shop-controls {
    padding: 1.5rem;
  }
  
  .filters {
    margin-bottom: 1rem;
  }
  
  .shop-actions {
    text-align: left;
  }
}
</style>

</body>
</html>
