<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Manage Users</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="/css/style.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background-color: #f9fafb;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 960px;
    }
    table {
      background-color: #fff;
    }

    /* Toast Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: #fff;
      font-weight: 500;
      transform: translateY(-100%);
      animation: slideIn 0.4s ease forwards;
      z-index: 9999;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }

    .notification.success {
      background: linear-gradient(45deg, #28a745, #20c997);
    }

    .notification.error {
      background: linear-gradient(45deg, #dc3545, #f86d7d);
    }

    .notification.warning {
      background: linear-gradient(45deg, #ffc107, #ffdb4d);
      color: #000;
    }

    .notification.info {
      background: linear-gradient(45deg, #17a2b8, #4dd4e9);
    }

    @keyframes slideIn {
      0% {
        transform: translateY(-100%);
        opacity: 0;
      }
      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      0% {
        opacity: 1;
        transform: translateY(0);
      }
      100% {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    .notification.fade-out {
      animation: fadeOut 0.4s ease forwards;
    }

    /* Optional: Add icon space */
    .notification::before {
      margin-right: 8px;
      font-family: "bootstrap-icons";
    }

    .notification.success::before {
      content: "✓";
    }

    .notification.error::before {
      content: "✕";
    }

    .notification.warning::before {
      content: "!";
    }

    .notification.info::before {
      content: "i";
    }
</style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="/admin/dashboard">Admin Dashboard</a>
      <div class="navbar-nav">
        <a class="nav-link active" href="/admin-users">Users</a>
        <a class="nav-link" href="/admin-orders">Orders</a>
        <a class="nav-link" href="/admin/products">Products</a>
        <a class="nav-link" href="/admin-charts">Analytics</a>
        <a class="nav-link" href="/admin-categories">Categories</a>
        <a class="nav-link text-danger" href="/logout">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">User Management</h2>
      <button class="btn btn-primary" onclick="loadUsers()">Refresh Users</button>
    </div>
    <table class="table table-bordered table-hover">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="userTableBody">
        <tr><td colspan="7" class="text-center">Loading users...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    // Check admin access first
    async function checkAdminAccess() {
      try {
        const response = await fetch('/session-data');
        const data = await response.json();
        
        if (!data.loggedIn || data.user.role !== 'admin') {
          alert('Access Denied: Only administrators can access this page');
          window.location.href = '/';
          return false;
        }
        return true;
      } catch (error) {
        console.error('Error checking admin access:', error);
        alert('Error verifying admin access');
        return false;
      }
    }

    async function loadUsers() {
      const tbody = document.getElementById('userTableBody');
      tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading users...</td></tr>';
      
      try {
        const response = await fetch('/api/admin/users');
        if (!response.ok) {
          if (response.status === 403) {
            throw new Error('Access denied. Admin privileges required.');
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        tbody.innerHTML = '';
        
        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center">No users found.</td></tr>';
          return;
        }
        
        data.forEach(user => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${user.id}</td>
            <td>${user.fname || ''}</td>
            <td>${user.lname || ''}</td>
            <td>${user.email}</td>
            <td><span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-primary'}">${user.role}</span></td>
            <td>
              <select class="form-select form-select-sm" onchange="updateStatus(${user.id}, this.value)">
                <option value="active" ${user.status === 'active' ? 'selected' : ''}>Active</option>
                <option value="inactive" ${user.status === 'inactive' ? 'selected' : ''}>Inactive</option>
              </select>
            </td>
            <td>
              <button class="btn btn-sm btn-warning me-1" onclick="editRole(${user.id}, '${user.role}')">Edit Role</button>
              <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Failed to fetch users:', err);
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-danger">
              <strong>Error loading users:</strong><br>
              <small>${err.message}</small><br>
              <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadUsers()">Try Again</button>
            </td>
          </tr>
        `;
      }
    }

    function updateStatus(userId, newStatus) {
      fetch(`/api/admin/users/${userId}/status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(`✅ User ${newStatus === 'active' ? 'activated' : 'inactivated'} successfully.`);
          loadUsers();
        } else {
          alert('❌ Failed to update status.');
        }
      })
      .catch(err => {
        console.error('Error updating status:', err);
        alert('❌ Error updating status.');
      });
    }

    function editRole(userId, currentRole) {
      const newRole = prompt('Enter new role (admin/customer):', currentRole);
      if (newRole && (newRole === 'admin' || newRole === 'customer')) {
        fetch(`/api/admin/users/${userId}/role`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role: newRole })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('✅ Role updated successfully.');
            loadUsers();
          } else {
            alert('❌ Failed to update role.');
          }
        })
        .catch(err => {
          console.error('Error updating role:', err);
          alert('❌ Error updating role.');
        });
      } else {
        alert('Invalid role. Must be "admin" or "customer".');
      }
    }

    function deleteUser(userId) {
      if (confirm('Are you sure you want to delete this user?')) {
        fetch(`/api/admin/users/${userId}`, {
          method: 'DELETE'
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('✅ User deleted successfully.');
            loadUsers();
          } else {
            alert('❌ Failed to delete user.');
          }
        })
        .catch(err => {
          console.error('Error deleting user:', err);
          alert('❌ Error deleting user.');
        });
      }
    }

    // Load users on page load
    document.addEventListener('DOMContentLoaded', async function() {
      const hasAccess = await checkAdminAccess();
      if (hasAccess) {
        loadUsers();
      }
    });
  </script>
</body>
</html>
